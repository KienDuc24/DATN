<!DOCTYPE html>
<html lang="vi">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Äáº·t láº¡i máº­t kháº©u</title>
Â  Â  <link rel="stylesheet" href="css/auth.css">
Â  Â  <link rel="stylesheet" href="css/styles.css">
<style>
Â body { 
    display: flex;
    justify-content: center; 
    align-items: center; height: 100vh; 
    background: #1a1a2e; color: white;
    margin: 0; font-family: 'Quicksand', sans-serif; 
}
.reset-box { 
    background: #23272f; 
    padding: 30px; 
    border-radius: 16px; 
    width: 90%; 
    max-width: 400px; 
    text-align: center; 
    box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
}
input { 
    width: 100%; 
    padding: 12px; 
    margin: 10px 0; 
    border-radius: 8px; 
    border: 1px solid #444; 
    background: #181c23; 
    color: white; 
    box-sizing: border-box; 
}
button { 
    width: 100%; 
    padding: 12px; 
    background: #ff9800; 
    border: none; 
    border-radius: 8px; 
    color: white; 
    font-weight: bold; 
    cursor: pointer; 
    margin-top: 10px; 
}
button:hover { 
    background: #e68900; 
}
h2 { 
    color: #ff9800; 
    margin-top: 0; 
    margin-bottom: 10px;
}

/* ThÃªm style cho pháº§n hiá»ƒn thá»‹ tÃ i khoáº£n */
.account-info {
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 0.95rem;
    color: #ccc;
}
.account-highlight {
    color: #43cea2;
    font-weight: bold;
    display: block;
    margin-top: 5px;
    font-size: 1.1rem;
}
/* Style cho nÃºt toggle password */
#togglePassBtn {
    background: none !important;
    color: #ff9800 !important;
    border: none;
    padding: 5px 0;
    margin-top: 5px;
    font-weight: bold;
    cursor: pointer;
    width: auto;
    display: block;
    margin-left: auto;
    text-align: right;
    box-shadow: none !important;
}
Â  Â  </style> 
</head>
<body>
Â  Â  <div class="reset-box">
Â  Â  Â  Â  <h2 id="titleText">Äáº·t láº¡i máº­t kháº©u</h2>
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="accountDisplay" class="account-info" style="display:none;">
Â  Â  Â  Â  Â  Â  Äang Ä‘áº·t láº¡i cho tÃ i khoáº£n:
Â  Â  Â  Â  Â  Â  <span id="accountName" class="account-highlight">...</span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <form id="resetForm" style="display:none;"> 
            <input type="password" id="newPass" placeholder="Máº­t kháº©u má»›i" required>
Â  Â  Â  Â  Â  Â  <input type="password" id="confirmPass" placeholder="Nháº­p láº¡i máº­t kháº©u" required>
            <button type="button" id="togglePassBtn">
                ğŸ‘ Hiá»‡n máº­t kháº©u
            </button>
            Â  Â  Â  Â  Â  Â  <button type="submit" id="btnConfirm">XÃ¡c nháº­n</button>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  
Â  Â  Â  Â  <p id="message" style="margin-top:15px; color:#ff9800; font-size: 0.9rem;">Äang kiá»ƒm tra liÃªn káº¿t...</p>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const API_BASE_URL = 'https://datn-socket.up.railway.app'; 
Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  const token = urlParams.get('token');
Â  Â  Â  Â  
Â  Â  Â  Â  const msg = document.getElementById('message');
Â  Â  Â  Â  const form = document.getElementById('resetForm');
Â  Â  Â  Â  const accDisplay = document.getElementById('accountDisplay');
Â  Â  Â  Â  const accNameSpan = document.getElementById('accountName');
        
        // Khai bÃ¡o cÃ¡c input vÃ  nÃºt toggle
        const newPass = document.getElementById('newPass');
        const confirmPass = document.getElementById('confirmPass');
        const toggleBtn = document.getElementById('togglePassBtn');

        // --- BÆ¯á»šC 1: Gá»ŒI API Äá»‚ Láº¤Y THÃ”NG TIN USER KHI VÃ€O TRANG (ÄÃƒ FIX URL) ---
        if (!token) {
            msg.style.color = '#ff4757';
            msg.innerText = 'LiÃªn káº¿t khÃ´ng há»£p lá»‡ (thiáº¿u token).';
        } else {
            // ÄÃƒ Sá»¬A: Gá»i Ä‘Ãºng endpoint GET /reset-info/:token
            fetch(`${API_BASE_URL}/api/auth/reset-info/${token}`) 
                .then(res => res.json())
                .then(data => {
                    if (data.valid) {
                        // Token Ä‘Ãºng -> Hiá»‡n form vÃ  tÃªn ngÆ°á»i dÃ¹ng
                        msg.innerText = '';
                        accNameSpan.innerText = data.account; // Hiá»ƒn thá»‹ email/username
                        accDisplay.style.display = 'block';
                        form.style.display = 'block';
                    } else {
                        // Token sai/háº¿t háº¡n
                        msg.style.color = '#ff4757';
                        msg.innerText = data.message || 'LiÃªn káº¿t Ä‘Ã£ háº¿t háº¡n hoáº·c khÃ´ng há»£p lá»‡.';
                    }
                })
                .catch(err => {
                    console.error(err);
                    msg.style.color = '#ff4757';
                    msg.innerText = 'KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§.';
                });
        }
        
        // --- LOGIC áº¨N/HIá»†N Máº¬T KHáº¨U (Má»šI) ---
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                const isPassword = newPass.type === 'password';
                newPass.type = isPassword ? 'text' : 'password';
                confirmPass.type = isPassword ? 'text' : 'password';

                toggleBtn.innerHTML = isPassword ? 'ğŸ™ˆ áº¨n máº­t kháº©u' : 'ğŸ‘ Hiá»‡n máº­t kháº©u';
            });
        }

        // --- BÆ¯á»šC 2: Xá»¬ LÃ Äá»”I Máº¬T KHáº¨U ---
        form.addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const p1 = newPass.value; // Láº¥y giÃ¡ trá»‹ tá»« biáº¿n Ä‘Ã£ khai bÃ¡o
Â  Â  Â  Â  Â  Â  const p2 = confirmPass.value; // Láº¥y giÃ¡ trá»‹ tá»« biáº¿n Ä‘Ã£ khai bÃ¡o

Â  Â  Â  Â  Â  Â  if (p1 !== p2) {
Â  Â  Â  Â  Â  Â  Â  Â  msg.style.color = '#ff4757';
Â  Â  Â  Â  Â  Â  Â  Â  msg.innerText = 'Máº­t kháº©u khÃ´ng khá»›p!';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  msg.style.color = '#ff9800';
Â  Â  Â  Â  Â  Â  msg.innerText = 'Äang xá»­ lÃ½...';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_BASE_URL}/api/auth/reset-password/${token}`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'PUT',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ password: p1 })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg.style.color = '#4caf50';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg.innerText = 'ThÃ nh cÃ´ng! Äang chuyá»ƒn vá» trang chá»§...';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.style.display = 'none'; // áº¨n form Ä‘i
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => window.location.href = '/index.html', 2000);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg.style.color = '#ff4757';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg.innerText = data.message || 'Lá»—i Ä‘áº·t láº¡i máº­t kháº©u.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  msg.style.color = '#ff4757';
Â  Â  Â  Â  Â  Â  Â  Â  msg.innerText = 'Lá»—i káº¿t ná»‘i server.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>